<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Easy bike fit - Fit better</title>
    
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">     
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">    
    <link href="src/assets/style.css" rel='stylesheet' type='text/css' />  
</head>
<body>          
    <div class="container-fluid" style="margin-top: 15px;">     
        <div class="row">
            <div class="col-md-2">
                <div>
                    <img src='src/assets/img/logo.jpg' style="max-width: 100%; max-height: 100%; margin-bottom: 1px;">
                    <a href="https://www.facebook.com/easybikefit"><span class="fb-icon"></span></a>
                </div>                
                <div class="panel panel-default">
                    <div class="panel-heading">
                        Angles
                    </div>
                    <div class="panel-body">
                        <div class="dropdown btn-group-sm" style="margin-bottom: 5px;">
                            <span>Bike type</span>
                            <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-expanded="true">
                                Road
                                <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-right" id="bikeTypesList" role="menu" aria-labelledby="dropdownMenu1">                           
                            </ul>
                        </div>

                        <!--
                            <angle name> <points>
                              Current angle: <angleValue>
                              Recommended range: <r1> - <r2>
                          -->                          
                          <div af="kneeExtension" class="angles"></div>
                          <div af="kneeFlexion" class="angles"></div>
                          <div af="armForeArm" class="angles"></div>                                                  
                          <div af="hipOpen" class="angles"></div>                     
                          <div af="armPit" class="angles"></div>                                  

                          <div af="backAngle" class="angles"></div>                           
                      </div>
                  </div>

                  <div class="panel panel-default">
                    <div class="panel-heading">Lengths</div>
                    <div class="panel-body">
                    <!--
                        <line name> <points> <lineLength>                           
                       -->                     
                       <span class="">Length of reference </span>
                       <input type="text" class="form-control" id="inputLength" style="width: 50px;display: inline;" placeholder="cm"><span> cm</span>
                       <br>
                       <div class="lines" lf="armLine"></div>                        
                       <div class="lines" lf="foreArmLine"></div>                        
                       <div class="lines" lf="thighLine"></div>                        
                       <div class="lines" lf="shinLine"></div>                     
                       <div class="lines" lf="hipToWristH"></div>                      
                       <div class="lines" lf="hipToWristV"></div>
                   </div>
               </div>

               <div class="panel panel-default panel-custom-tool">
                <div class="panel-heading clearfix">
                    <span>Custom measurements</span>
                    <span class="glyphicon glyphicon-plus pull-right" aria-hidden="true" id="btnAddCustomTool"></span>
                </div>
                <div class="panel-body custom-tool-template" style="display: none;">
                    <div class="custom_lines">
                        <span class="close remove-custom-tool glyphicon glyphicon-remove"></span>                               
                        <span class="numberCircle"></span><span class="numberCircle"></span><span class="angleName">Length: </span>
                        <span class="angleText" id="customLength0"></span>
                        <br>
                        <span class="numberCircle"></span><span class="numberCircle"></span><span class="angleName">Length: </span>
                        <span class="angleText" id="customLength1"></span>
                        <br>
                        <span class="angleName">Angle between </span><span class="angleText" id="customAngle"></span>                   
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-10">            
            <div class="stepWorkArea alert alert-header" role="alert">                                          
                <span class="btn btn-primary btn-file">Upload a photo or video of you
                    <input type="file" id="fileOne" accept="video/*,image/*" class="clickable">
                </span>                

                <div class="inline" style="display:none;margin-left: 15px;" id="videoControls">
                    <span id="rwd" class="video-control unselectable glyphicon glyphicon-backward"></span>
                    <span id="play" class="video-control unselectable glyphicon glyphicon-pause"></span>
                    <span id="fwd" class="video-control unselectable glyphicon glyphicon-forward"></span>
                    <span>Advance/rewind by: </span>
                    <input type="text" class="form-control" id="advanceValue" style="width: 70px;display: inline;" value="0.25">    
                </div>
                
                <button class="btn btn-file btn-primary clickable pull-right" data-toggle="modal" data-target="#feedback">Send feedback</button>

                <div class="modal fade" id="feedback" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static" >
                  <div class="modal-dialog">
                    <div class="modal-content" style="width: 690px; ">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel"></h4>
                      </div>
                      <div class="modal-body">
                          <iframe src="https://docs.google.com/forms/d/1SCI359flJ26Gxt8ypAPbn5Fxd96i2H8zjmpJl9t3pwE/viewform?embedded=true" width="660" height="750" frameborder="0" marginheight="0" marginwidth="0">Loading...</iframe>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>                        
                      </div>
                    </div>                    
                  </div>                  
                </div>

                <button type="button" id="btn_get_started" class="btn btn-file btn-primary clickable pull-right" data-toggle="buttons">
                    Help <span class="caret"></span></button>                                            
                </div>                   
                
                <div class="stepCanvasArea" style="width: 100%; height: 100%; pointer-events: none;">
                    <video id="riderVideo" class="video-js vjs-default-skin" style="width: 100%; display: none;" autoplay loop></video>

                    
                    <canvas id="stepOneCanvas" style="pointer-events: all; top: 45px; width: 100%; height: 100%; position: absolute;"></canvas> 
                    <canvas id="zoom" class="lens" width="200" height="200" style="display: none;"></canvas>

                    <div class="col-md-3 pull-right" id="panel_get_started" style="display:none; margin-top: 5px;padding-right: 0px;">
                        <div class="panel panel-default">
                            <div class="panel-heading">How to use this tool</div>
                            <div class="panel-body">
                                <span>Take a picture of you sitting on the bike in your usual riding position. You can use your trainer or whatever is more convenient for you. If you don't have a trainer, you can also lean against a wall or have someone hold you upright. Once you have the picture, upload it and start moving the dotted letters to match your joints like so:</span>
                                <ul style="list-style-type: none; padding-left: 5px;">
                                    <li><span class="numberCircle">A</span> - shoulder
                                        <span class="numberCircle">B</span> - elbow
                                        <span class="numberCircle">C</span> - wrist</li>
                                        <li><span class="numberCircle">D</span><span style="margin-right: 2.5em;"> - hip</span>
                                            <span class="numberCircle">E</span><span style="margin-right: 0.4em;"> - knee</span>
                                            <span class="numberCircle">F</span> - ankle</li>                            
                                        </ul>
                                        <span><strong>Tip:</strong> to help you position the points, you can stick a small piece of colored electrical take on your joints.</span>
                                        <br><br>
                                        <span>Once you have all the points set up, check the table on the left side to see if the angles fall in the recommended ranges.</span>
                                        <br><br>
                                        <strong>Length reference: </strong><span>use the <span class="numberCircle">H</span> and <span class="numberCircle">I</span>points to mark something in your picture whose length you know. Once you have a length reference marked, input it's actual length in centimeters in the corresponding box. In this way we will know how to measure the rest of the elements in your picture.</span>
                                        <br><br>
                                        <strong>Fixes: </strong><span>If the angles don't fit in the recommended range, these are the items you should check:</span>
                                        <ul style="list-style-type: circle; padding-left: 15px;">
                                            <li><span>Saddle height - vertical movement</span></li>
                                            <li><span>Saddle setback - horizontal movement</span></li>
                                            <li><span>Stem length</span></li>
                                            <li><span>Handlebar height</span></li>
                                        </ul>

                                    </div>
                                </div>          
                            </div>  
                        </div>      
                    </div>
                </div>                
            </div>
        </div>
    </div>

    <script src="src/js/lib/jquery.min.js" type="text/javascript"></script>     
    <script src="src/js/lib/bootstrap.min.js" type="text/javascript"></script>  
    <script src="src/js/lib/paper-full.js" type="text/javascript"></script>
    <script src="src/js/lib/paper-core.js" type="text/javascript"></script>

    <script src="src/js/jointpoint.js" type="text/javascript"></script>
    <script src="src/js/line.js" type="text/javascript"></script>
    <script src="src/js/text.js" type="text/javascript"></script>
    <script src="src/js/jointsangle.js" type="text/javascript"></script>    
    <script src="src/js/dependentpoint.js" type="text/javascript"></script>
    <script src="src/js/scene.js" type="text/javascript"></script>
    <script src="src/js/vectorutils.js" type="text/javascript"></script>

    <script src="src/js/videoplayer.js" type="text/javascript"></script>    

    <script type="text/javascript">
    String.format = function() {
        // The string containing the format items (e.g. "{0}")
        // will and always has to be the first argument.
        var theString = arguments[0];

        // start with the second argument (i = 1)
        for (var i = 1; i < arguments.length; i++) {
            // "gm" = RegEx options for Global search (more than one instance)
            // and for Multiline search
            var regEx = new RegExp("\\{" + (i - 1) + "\\}", "gm");
            theString = theString.replace(regEx, arguments[i]);
        }
        
        return theString;
    }

    $(document).on('change', '.btn-file :file', function(evt) { 
        var input = $(this),
        numFiles = input.get(0).files ? input.get(0).files[0] : 1;
        input.trigger('fileselect', [numFiles, evt.target.id]);
    });

    $(document).ready(function() {
        var self = this;

        // Lens     
        var main = document.getElementById("stepOneCanvas");
        var zoom = document.getElementById("zoom");
        zoom.style.display = "none";

        var ctx = main.getContext("2d")
        var zoomCtx = zoom.getContext("2d");

        var onMoveHandler = function(e){  
            var clientX = !e.clientX ? e.touches[0].clientX : e.clientX;
            var clientY = !e.clientY ? e.touches[0].clientY : e.clientY;            

            var layerX = clientX -  $('#stepOneCanvas').offset().left;
            var layerY = clientY - $('#stepOneCanvas').offset().top;
            
            zoomCtx.fillStyle = "white";
            zoomCtx.fillRect(0,0, zoom.width, zoom.height);
            zoomCtx.drawImage(main,  layerX -100, layerY-100, 200, 200, -50,-50, 300, 300);

//alert(layerX + ' ' + layerY + ' ' + zoom.width);

            zoom.style.top = clientY - 220 + "px"
            zoom.style.left = (layerX - 220) + "px"            
        };

        $('#stepOneCanvas')[0].addEventListener("mousemove", onMoveHandler);
        $('#stepOneCanvas')[0].addEventListener("touchmove", onMoveHandler);

        $('#stepOneCanvas').on("mousedown touchstart", function(e){
            zoom.style.display = "block";
            onMoveHandler(e);
        });

        $('#stepOneCanvas').on("mouseup touchend", function(){            
            zoom.style.display = "none";
        });

        paper.install(window);

        var lastCustomToolY = 200;
        var lastCustomToolNo = 0;

        self.customToolsList = [];
        self.ranges = {};

        self.points = {};
        self.lines = {};
        self.angles = {};
        self.texts = {};                    

        var letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        var lastLabel = 0;          

        var windowHeight = 0.9 * $(window).height();
        var canvasDiv = $('.stepCanvasArea');
        canvasDiv.height(windowHeight);

        $('#stepOneCanvas').width(canvasDiv.width());
        $('#stepOneCanvas').height(canvasDiv.height());        

        $('#btn_get_started').on('click', function (e) {        
            $('#panel_get_started').toggle(0,'show');        
        });

        self.video = new VideoPlayer('riderVideo');
        self.videoAdvanceValue = 0.25;
        self.video.height(windowHeight);

        self.videoControls = $('#videoControls');

        self.video.onStatusChanged(function (status) {        
            var playBtn = $('#play');
            playBtn.removeClass('glyphicon-play');
            playBtn.removeClass('glyphicon-pause');

            playBtn.addClass(status['playbackStatus'] == true ? 'glyphicon-play' : 'glyphicon-pause');
        });

        self.videoControls.find('#play').click(function (evt) {
            self.video.togglePlayPause();
        });

        self.videoControls.find('#rwd').click(function (evt) {                      
            self.video.pause();
            self.video.advance(-self.videoAdvanceValue);
        });

        self.videoControls.find('#fwd').click(function (evt) {
            self.video.pause();         
            self.video.advance(self.videoAdvanceValue);
        });

        var advanceValue = $('#advanceValue');
        advanceValue.bind("propertychange change click keyup input paste", function(e) { 
            var parsedValue = parseFloat(advanceValue.val());           

            if (parsedValue != NaN) {
                self.videoAdvanceValue = parsedValue !== NaN ? parsedValue : self.videoAdvanceValue;                
            }   
        });

        self.videoControls.hide();

        var inputLength = $('#inputLength');        

        self.refDistanceCM = 0;
        self.refDistanceInPixels = 0;
        self.refDistanceCMPerPixel  = 0;

        $('.btn-file :file').on('fileselect', function(event, numFiles, targetId) {         
            var file = event.target.files[0];
            var type = file.type;

            var imageMimes = ['image/png', 'image/gif', 'image/bmp', 'image/jpg', 'image/jpeg'];

            if (imageMimes.indexOf(type) != -1) {
                var file = new FileReader();            
                file.readAsDataURL(event.target.files[0]);

                file.onload = function(evt) {
                    self.video.show(false);
                    self.videoControls.hide();
                    
                    self.sceneTop.loadImage(evt.target.result);             
                }       

                return;
            }           

            if (!window.URL && !window.webkitURL) {
                alert('Your browser is not ' + '<a href="http://caniuse.com/bloburls">supported</a>!', true);
                return;
            }           

            var isOk = self.video.canPlay(type);
            var message = 'Can play type "' + type + '": ' + isOk;          

            if (!isOk) { return; }                  

            $('.stepCanvasArea').css('background-image', 'none');

            var fileURL = URL.createObjectURL(file);                

            self.video.show(true);  
            self.videoControls.show();      
            self.video.setSource(fileURL);          
        });

        $('.stepHeader').click(function(event) {            
            if (event.target.localName == 'input')
                return;

            $.each($('.stepHeader'), function (index, step) {
                var menuIco = $(step).find('#stepOneDropdownIco');          
                //Close
                if (menuIco.hasClass('glyphicon-chevron-down') == true) {
                    menuIco.removeClass('glyphicon-chevron-down');
                    menuIco.addClass('glyphicon-chevron-right');

                    $($(this).siblings()[0]).animate({ height: "toggle", opacity: 0 }, 500, function() {
                        $($(step).siblings()[0]).css('opacity', '0');
                    });  

                } else { // Open
                    menuIco.addClass('glyphicon-chevron-down');
                    menuIco.removeClass('glyphicon-chevron-right');

                    $($(this).siblings()[0]).animate({ height: "toggle", opacity: 1 }, 500, function() {
                        $($(step).siblings()[0]).css('opacity', '1');
                    });                 
                }
            });
        });

        $('#btnAddCustomTool').click(function () {
            var getNextLabel = self.getNextLabel;
            var onAngleChanged = self.onAngleChanged;
            var onLineLengthChanged = self.onCustomToolLineChanged;

            var startLabel = getNextLabel();
            var middleLabel = getNextLabel();
            var endLabel = getNextLabel();

            points = [      
            {'x': 49,  'y' : lastCustomToolY,  'scale' : false, 'name' : SceneUtils.KnownPoints.CUST_TOOL_START + lastCustomToolNo, 'label' : startLabel},
            {'x': 140, 'y' : lastCustomToolY,  'scale' : false, 'name' : SceneUtils.KnownPoints.CUST_TOOL_MIDDLE + lastCustomToolNo, 'label' : middleLabel},
            {'x': 230, 'y' : lastCustomToolY + 20,  'scale' : false, 'name' : SceneUtils.KnownPoints.CUST_TOOL_END + lastCustomToolNo, 'label' : endLabel},
            ];

            var customToolBase = SceneUtils.KnownLines.CUSTOM_TOOL + '_' + lastCustomToolNo + '_';

            lines = [
            { 'name' : customToolBase + '0', 'points' : [SceneUtils.KnownPoints.CUST_TOOL_START + lastCustomToolNo, SceneUtils.KnownPoints.CUST_TOOL_MIDDLE + lastCustomToolNo], 'onLineLengthChanged' : onLineLengthChanged},
            { 'name' : customToolBase + '1', 'points' : [SceneUtils.KnownPoints.CUST_TOOL_MIDDLE + lastCustomToolNo, SceneUtils.KnownPoints.CUST_TOOL_END + lastCustomToolNo], 'onLineLengthChanged' : onLineLengthChanged},
            ];

            angles = [
            { 'name': SceneUtils.KnownAngles.CUSTOM_ANGLE + lastCustomToolNo, 'side_first' : customToolBase + '0', 'side_second' : customToolBase + '1', 'onAngleChanged' : onAngleChanged},
            ];

            self.sceneTop.load(points, lines, angles, []);      

            var template = $('.custom-tool-template').clone();
            var firstPoint = template.find('#customLength0').attr('id', customToolBase + '0').prev();
            firstPoint.prev().prev().text(startLabel);
            firstPoint.prev().text(middleLabel);

            var secondPoint = template.find('#customLength1').attr('id', customToolBase + '1').prev();
            secondPoint.prev().prev().text(middleLabel);
            secondPoint.prev().text(endLabel);

            template.find('#customAngle').attr('id', SceneUtils.KnownAngles.CUSTOM_ANGLE + lastCustomToolNo);
            template.find('.remove-custom-tool').attr('ctx', customToolBase).removeClass('remove-custom-tool').addClass('remove-custom-tool' + lastCustomToolNo);

            template.removeClass('custom-tool-template');
            template.addClass('custom-tool-' + lastCustomToolNo);

            template.show();
            self.customToolsList.push(customToolBase);

            $('.panel-custom-tool').append(template[0].outerHTML);
            $('.remove-custom-tool' + lastCustomToolNo).click(function() {
                var ctx = $(this).attr('ctx');
                self.customToolsList.splice(self.customToolsList.indexOf(ctx), 1);

                var toolNo = self.getToolIdFromName(ctx);

                var pointIdsToRemove = [SceneUtils.KnownPoints.CUST_TOOL_START + toolNo, SceneUtils.KnownPoints.CUST_TOOL_MIDDLE + toolNo, SceneUtils.KnownPoints.CUST_TOOL_END + toolNo];
                var lineIdsToRemove = [ctx + '0', ctx + '1'];
                var angleIdsToRemove = [SceneUtils.KnownAngles.CUSTOM_ANGLE + toolNo];

                self.sceneTop.unload(pointIdsToRemove, lineIdsToRemove, angleIdsToRemove);

                $(this).parent().parent().detach();
            });

            $('.custom-tool-' + lastCustomToolNo).hover(function () {
                self.sceneTop.highlightPoints([startLabel, middleLabel, endLabel]);
            }, function () {
                self.sceneTop.unhighlightAll();
            });

            lastCustomToolY += 40;
            lastCustomToolNo += 1;
        });       

        inputLength.data('oldVal', inputLength.val());
        inputLength.bind("propertychange change click keyup input paste", function(e) {        
            if (inputLength.data('oldVal') != inputLength.val()) {        
                inputLength.data('oldVal', inputLength.val());
                self.refDistanceCM = inputLength.val() != '' ? inputLength.val() : 0;
                self.refDistanceCMPerPixel  = self.refDistanceCM / self.refDistanceInPixels;

                self.updateLineSizes();
                self.onCustomToolLineChanged();
            }
        });

        [inputLength, advanceValue].forEach(function (ctrl) {
            ctrl.keydown(function(event) {
                var allowedKeyCodes = [8, 9, 13, 27, 37, 39, 46];
                if (allowedKeyCodes.indexOf(event.keyCode) != -1 
                    || (event.keyCode == 190 && $(this).val().indexOf('.') == -1)
                    || (event.keyCode == 65 && event.ctrlKey === true) 
                    || (event.keyCode >= 35 && event.keyCode <= 39)) 
                    return;         

                if (event.shiftKey || (event.keyCode < 48 || event.keyCode > 57) && (event.keyCode < 96 || event.keyCode > 105 )) {
                    event.preventDefault(); 
                }   
            });
        });

        self.ranges['road'] = [
            {'name' : SceneUtils.KnownAngles.ARM_FOREARM, 'ranges': [{'range' : [150, 170], 'color' : 'green'}]},
            {'name' : SceneUtils.KnownAngles.KNEE_FLEXION, 'ranges' : [{'range' : [35, 40], 'color' : 'green'}]},
            {'name' : SceneUtils.KnownAngles.KNEE_EXTENSION, 'ranges' : [{'range' : [140, 145], 'color' : 'green'}]},
            {'name' : SceneUtils.KnownAngles.ARM_PIT, 'ranges' : [{'range' : [80, 90], 'color' : 'green'}]},
            {'name' : SceneUtils.KnownAngles.BACK_ANGLE, 'ranges' : [{'range' : [40, 45], 'color' : 'green'}]},
        ];

        self.ranges['mtb'] = [
            {'name' : SceneUtils.KnownAngles.ARM_FOREARM, 'ranges': [{'range' : [150, 170], 'color' : 'green'}]},
            {'name' : SceneUtils.KnownAngles.KNEE_FLEXION, 'ranges' : [{'range' : [35, 40], 'color' : 'green'}]},
            {'name' : SceneUtils.KnownAngles.KNEE_EXTENSION, 'ranges' : [{'range' : [140, 145], 'color' : 'green'}]},
            {'name' : SceneUtils.KnownAngles.ARM_PIT, 'ranges' : [{'range' : [75, 80], 'color' : 'green'}]},
            {'name' : SceneUtils.KnownAngles.BACK_ANGLE, 'ranges' : [{'range' : [45, 50], 'color' : 'green'}]},
        ];

        self.ranges['tt'] = [
            {'name' : SceneUtils.KnownAngles.ARM_FOREARM, 'ranges': [{'range' : [90, 100], 'color' : 'green'}]},
            {'name' : SceneUtils.KnownAngles.KNEE_FLEXION, 'ranges' : [{'range' : [37, 42], 'color' : 'green'}]},
            {'name' : SceneUtils.KnownAngles.KNEE_EXTENSION, 'ranges' : [{'range' : [138, 143], 'color' : 'green'}]},
            {'name' : SceneUtils.KnownAngles.ARM_PIT, 'ranges' : [{'range' : [75, 80], 'color' : 'green'}]},
            {'name' : SceneUtils.KnownAngles.BACK_ANGLE, 'ranges' : [{'range' : [20, 22], 'color' : 'green'}]},
        ];

        self.ranges['tri'] = [
            {'name' : SceneUtils.KnownAngles.ARM_FOREARM, 'ranges': [{'range' : [90, 100], 'color' : 'green'}]},
            {'name' : SceneUtils.KnownAngles.KNEE_FLEXION, 'ranges' : [{'range' : [37, 42], 'color' : 'green'}]},
            {'name' : SceneUtils.KnownAngles.KNEE_EXTENSION, 'ranges' : [{'range' : [138, 143], 'color' : 'green'}]},
            {'name' : SceneUtils.KnownAngles.ARM_PIT, 'ranges' : [{'range' : [70, 75], 'color' : 'green'}]},
            {'name' : SceneUtils.KnownAngles.BACK_ANGLE, 'ranges' : [{'range' : [22, 25], 'color' : 'green'}]},
        ];

        self.buildAngleRanges = function () {
            function measurementLabel(name) {
                switch (name)
                {
                    case SceneUtils.KnownAngles.ARM_FOREARM:
                    return 'Elbow Angle';
                    case SceneUtils.KnownAngles.KNEE_FLEXION:
                    return 'Knee Flexion';
                    case SceneUtils.KnownAngles.KNEE_EXTENSION:
                    return 'Knee Extension';
                    case SceneUtils.KnownAngles.HIP_OPEN:
                    return 'Hip Open';
                    case SceneUtils.KnownAngles.ARM_PIT:
                    return 'Shoulder Elbow';
                    case SceneUtils.KnownAngles.BACK_ANGLE:
                    return 'Back Angle';
                    case SceneUtils.KnownLines.THIGH_LINE:
                    return 'Thigh Line';
                    case SceneUtils.KnownLines.SHIN_LINE:
                    return 'Shin Line';
                    case SceneUtils.KnownLines.BACK_LINE:
                    return 'Back Line';
                    case SceneUtils.KnownLines.HIP_TO_WRIST_H:
                    return 'Hip to wrist (horiz)';
                    case SceneUtils.KnownLines.HIP_TO_WRIST_V:
                    return 'Hip to wrist (vertical)';
                    default:
                    return "";
                }
            }

        self.getLabels = function(angle) {
            switch (angle) {
                case SceneUtils.KnownAngles.ARM_FOREARM:
                return ['A', 'B', 'C'];
                case SceneUtils.KnownAngles.KNEE_FLEXION:
                return ['D', 'E', 'F'];
                case SceneUtils.KnownAngles.KNEE_EXTENSION:
                return ['F', 'E', 'G'];
                case SceneUtils.KnownAngles.ARM_PIT:
                return ['D', 'A', 'B'];
                case SceneUtils.KnownAngles.BACK_ANGLE:
                return ['A', 'D'];
                case SceneUtils.KnownLines.ARM_LINE:
                return ['A', 'B'];
                case SceneUtils.KnownLines.FOREARM_LINE:
                return ['B', 'C'];
                case SceneUtils.KnownLines.THIGH_LINE:
                return ['D', 'E'];
                case SceneUtils.KnownLines.SHIN_LINE:
                return ['E', 'F'];
                case SceneUtils.KnownLines.HIP_TO_WRIST_H:
                return ['D', 'C'];
                case SceneUtils.KnownLines.HIP_TO_WRIST_V:
                return ['D', 'C'];
                default:
                return [];
            }           
        }  

        var bikeTypesList = $('#bikeTypesList');
        var bikeTypes = ['road', 'mtb', 'tri', 'tt'];
        self.bikeType = 'road';
        var bikeTypeLables = ['Road', 'MTB', 'Triathlon', 'Time trial'];

        for (var i = 0; i < bikeTypes.length; i++) {
            var a = $('<a/>', {
                role : 'menuitem',
                value : bikeTypes[i],
                tabindex : '-1',
                href : '#',
                class : 'strong',
                text : bikeTypeLables[i]
            });

            var li = $('<li/>', {
                role : 'presentation'
            });

            li.append(a);
            bikeTypesList.append(li);

            for (var j = 0; j < self.ranges[bikeTypes[i]].length; j++) {
                var currRange = self.ranges[bikeTypes[i]][j]['ranges'][0]['range'];
                var label = measurementLabel(self.ranges[bikeTypes[i]][j]['name']);

                var li = $('<li/>', {
                    role : 'presentation',
                    class : 'dropdown-header unselectable',
                    text : label + ': '
                });

                var span = $('<span/>', {
                    class : 'strong',
                    text : currRange[0] + ' ' + currRange[1]
                });

                li.append(span);
                bikeTypesList.append(li);
            }
        } 

        self.getLabelsFormatted = function(angle) {
            var labels = self.getLabels(angle);         
            var labelsFormat = "";

            for (var i = 0; i < labels.length; i++) {
                labelsFormat += "<span class=\"numberCircle\">" + labels[i] + "</span>";
            };

            return labelsFormat;
        }           

        self.updateAngleHelp = function (range) {            
            $('.angles').each(function (i, elem) {
                var id = $(elem).attr('af'); 
                        
                $(elem).hover(function() {
                    self.sceneTop.highlightPoints(self.getLabels(id));                    
                }, function() {
                    self.sceneTop.unhighlightAll();
                });

                var angleName = measurementLabel(id);

                if (angleName == "") 
                    return;

                for (var i = 0; i < range.length; i++) {
                    if (range[i]['name'] == id) {
                        var ranges = range[i].ranges[0];

                        if ($(elem).children().length > 0) {
                            $(elem).find('#rr_' + id).text(String.format('{0}°-{1}°', ranges.range[0], ranges.range[1]));
                            continue;
                        }
                        
                        $(elem)
                        .append($('<div>').append($('<span>').text(angleName)).append($('<span>').attr('class', 'angleName').html(self.getLabelsFormatted(id))))
                        .append($('<div class=\"angleSubSection\">').append($('<span>').text('Current angle: ')).append($('<span>').attr('id', id).attr('class', 'angleText')))
                        .append($('<div class=\"angleSubSection\">').append($('<span>').text('Recommended range:')).append($('<span id=\"rr_' + id + '\" class="angleText">').text(String.format('{0}°-{1}°', ranges.range[0], ranges.range[1]))));

                        break;
                    }           
                }       
                
            });
        }

        self.buildLines = function () {
            $('.lines').each(function (i, elem) {
                var id = $(elem).attr('lf');

                $(elem).hover(function() {
                    self.sceneTop.highlightPoints(self.getLabels(id));                    
                }, function() {
                    self.sceneTop.unhighlightAll();
                });

                //var lineName = measurementLabel(id);

                //if (lineName == "") 
                //   return;

                $(elem)
                .append($('<div>').append($('<span>').attr('class', 'angleName').html(self.getLabelsFormatted(id)))
                .append($('<span>').attr('id', id).attr('class', 'angleText')))                
                    /*
                        <line name> <points>
                          Current length: <lineLength>
                          */
                });
        }();

        $(".dropdown-menu li a").click(function(){      
            $(this).parents(".dropdown").find('.btn').html($(this).text()+" <span class=\"caret\"></span>");
            $(this).parents(".dropdown").find('.btn').val($(this).text());

            self.bikeType = $(this).attr('value');   
            self.sceneTop.updateRanges(self.ranges[self.bikeType]);
            self.updateAngleHelp(self.ranges[self.bikeType]);
        });

        self.updateAngleHelp(self.ranges['road']);

        }();

        self.getRange = function(type, angle) {            
            var selectedRange = self.ranges[type];            
            for (idx in selectedRange) {
                if (selectedRange[idx]['name'] == angle) {                    
                    return selectedRange[idx]['ranges'];
                }
            }

            return [];
        }

        self.isAngleInRange = function (angle, target) {
            var range = self.getRange(self.bikeType, target);
            
            if (range === undefined || range.length == 0) 
                return true;
            
            if (angle >= range[0]['range'][0] && angle <= range[0]['range'][1]) {
                return true;
            }

            return false;
        }

        self.onAngleChanged = function(angle, target) {
            var isInRange = self.isAngleInRange(angle, target);
            var elem = undefined;            

            elem = $('#' + target);    
            elem.text(angle + '°');        

            elem.removeClass('angleOk').removeClass('angleNotOk');
            
            if (isInRange == true) 
                elem.addClass('angleOk');
            else
                elem.addClass('angleNotOk');            

            if (target == SceneUtils.KnownAngles.KNEE_EXTENSION) {
                var elem = $('#' + SceneUtils.KnownAngles.KNEE_FLEXION);
                elem.text((180 - angle).toFixed(1) + '°');

                elem.removeClass('angleOk').removeClass('angleNotOk');
            
                if (isInRange == true) 
                    elem.addClass('angleOk');
                else
                    elem.addClass('angleNotOk');            
            }
        }

        self.getToolIdFromName = function (target) {                                
            var indexToolId = target.indexOf('_');

            if (indexToolId == -1)
                return '-1';

            return target.substring(indexToolId + 1, target.indexOf('_', indexToolId + 1));         
        }

        self.onCustomToolLineChanged = function(f, t, target) {
            for (var i = 0; i < self.customToolsList.length; i++) {
                target = self.customToolsList[i];
                var toolId = self.getToolIdFromName(target);

                var currLine = target + '0';
                $('.custom-tool-' + toolId).find('#' + currLine).text(self.pixelsToMM(self.sceneTop.getLine(currLine).length()));
                currLine = target + '1';
                $('.custom-tool-' + toolId).find('#' + currLine).text(self.pixelsToMM(self.sceneTop.getLine(currLine).length()));
            }               
        }

        self.updateBackAngle = function() {
            var hLine = self.sceneTop.getLine(SceneUtils.KnownLines.HORIZONTAL_REF_LINE);
            var bLine = self.sceneTop.getLine(SceneUtils.KnownLines.BACK_LINE);

            if (hLine == undefined || bLine == undefined)
                return;

            var angle = GeometryUtils.AngleBetweenLines(hLine, bLine);
            $('#backAngle').text((180 - angle).toFixed(1) + '°');
        }

        // Custom tool angle
        self.updateCustomAngle = function() {
            var hLine = self.sceneTop.getLine(SceneUtils.KnownLines.HORIZONTAL_REF_LINE);
            var bLine = self.sceneTop.getLine(SceneUtils.KnownLines.CUSTOM_LINE);

            if (hLine == undefined || bLine == undefined)
                return;

            var angle = GeometryUtils.AngleBetweenLines(hLine, bLine);
            $('#customAngle').text(Math.abs(180-angle).toFixed(1) + '°' + ' / ' +angle.toFixed(1) + '°');
        }

        self.getCMPerPixel = function () {
            if (self.refDistanceInPixels == 0)
                return 0;

            return self.refDistanceCM / self.refDistanceInPixels;
        }

        self.pixelsToMM = function(val) {           
            return (val * 10 * self.getCMPerPixel()).toFixed(1) + ' mm';
        }

        self.updateLineSizes = function() {              
            var armLine = self.sceneTop.getLine(SceneUtils.KnownLines.ARM_LINE);
            $('#armLine').text(self.pixelsToMM(armLine != undefined ? armLine.length() : 0));

            var foreArmLine = self.sceneTop.getLine(SceneUtils.KnownLines.FOREARM_LINE);
            $('#foreArmLine').text(self.pixelsToMM(foreArmLine != undefined ? foreArmLine.length() : 0));
            
            var thighLine = self.sceneTop.getLine(SceneUtils.KnownLines.THIGH_LINE);
            $('#thighLine').text(self.pixelsToMM(thighLine != undefined ? thighLine.length() : 0));

            var shinLine = self.sceneTop.getLine(SceneUtils.KnownLines.SHIN_LINE);
            $('#shinLine').text(self.pixelsToMM(shinLine != undefined ? shinLine.length() : 0));

            var hipToWrist = self.sceneTop.getLine(SceneUtils.KnownLines.HIP_TO_WRIST);
            $('#hipToWristH').text(self.pixelsToMM(hipToWrist != undefined ? hipToWrist.horizontalDistance() : 0));
            $('#hipToWristV').text(self.pixelsToMM(hipToWrist != undefined ? hipToWrist.verticalDistance() : 0));

            var customLine = self.sceneTop.getLine(SceneUtils.KnownLines.CUSTOM_LINE);
            $('#endToEndH').text(self.pixelsToMM(customLine != undefined ? customLine.horizontalDistance() : 0));
            $('#endToEndV').text(self.pixelsToMM(customLine != undefined ? customLine.verticalDistance() : 0));
            $('#customLength').text(self.pixelsToMM(customLine != undefined ? customLine.length() : 0));
        }   

        self.getNextLabel = function() {
            if (lastLabel >= letters.length) {
                alert('no more letters');
            }

            var label = letters[lastLabel];
            lastLabel += 1;

            return label;
        }

        self.reloadScene = function () {
            self.canvasId = "stepOneCanvas";
            self.sceneTop.load(self.points[self.canvasId], self.lines[self.canvasId], self.angles[self.canvasId], self.texts[self.canvasId]);
        }

        self.setupCanvas = function(canvasId) {
            self.canvasId = canvasId;
            paper.setup(canvasId);      

            var getNextLabel = self.getNextLabel;
            var onAngleChanged = self.onAngleChanged;                   

            self.points['stepOneCanvas'] = [
            {'x': 647, 'y' : 140, 'scale' : true, 'name' : SceneUtils.KnownPoints.SHOULDER, 'label' : getNextLabel()},
            {'x': 703, 'y' : 246, 'scale' : true, 'name' : SceneUtils.KnownPoints.ELBOW, 'label' : getNextLabel()},
            {'x': 794, 'y' : 291, 'scale' : true, 'name' : SceneUtils.KnownPoints.WRIST, 'label' : getNextLabel()},
            {'x': 476, 'y' : 261, 'scale' : true, 'name' : SceneUtils.KnownPoints.HIP, 'label' : getNextLabel()},
            {'x': 615, 'y' : 370, 'scale' : true, 'name' : SceneUtils.KnownPoints.KNEE, 'label' : getNextLabel()},
            {'x': 597, 'y' : 541, 'scale' : true, 'name' : SceneUtils.KnownPoints.ANKLE, 'label' : getNextLabel()},
            {'x': 765, 'y' : 487, 'scale' : true, 'name' : SceneUtils.KnownPoints.KNEE_HIP_VIRTUAL, 'label' : getNextLabel(), 'unmovable' : true},

            {'x': 32,  'y' : 60, 'scale' : false, 'name' : SceneUtils.KnownPoints.LEN_REF_START, 'label' : getNextLabel()},
            {'x': 179, 'y' : 60, 'scale' : false, 'name' : SceneUtils.KnownPoints.LEN_REF_END, 'label' : getNextLabel()},

            {'x': 32, 'y' : 122, 'scale' : false, 'name' : SceneUtils.KnownPoints.HORIZ_REF_START, 'label' : getNextLabel()},
            {'x': 179, 'y' : 122, 'scale' : false, 'name' : SceneUtils.KnownPoints.HORIZ_REF_END, 'label' : getNextLabel()}         
            ];

            self.lines['stepOneCanvas'] = [
            { 'name' : SceneUtils.KnownLines.ARM_LINE, 'points' : [SceneUtils.KnownPoints.SHOULDER, SceneUtils.KnownPoints.ELBOW]},
            { 'name' : SceneUtils.KnownLines.FOREARM_LINE, 'points' : [SceneUtils.KnownPoints.ELBOW, SceneUtils.KnownPoints.WRIST]},
            { 'name' : SceneUtils.KnownLines.THIGH_LINE, 'points' : [SceneUtils.KnownPoints.HIP, SceneUtils.KnownPoints.KNEE]},
            { 'name' : SceneUtils.KnownLines.SHIN_LINE, 'points' : [SceneUtils.KnownPoints.KNEE, SceneUtils.KnownPoints.ANKLE]},
            { 'name' : SceneUtils.KnownLines.BACK_LINE, 'points' : [SceneUtils.KnownPoints.HIP, SceneUtils.KnownPoints.SHOULDER]},

            { 'name' : SceneUtils.KnownLines.HIP_TO_WRIST, 'points' : [SceneUtils.KnownPoints.HIP, SceneUtils.KnownPoints.WRIST], 'visible' : false},

            { 'name' : SceneUtils.KnownLines.DISTANCE_REF_LINE, 'points' : [SceneUtils.KnownPoints.LEN_REF_START, SceneUtils.KnownPoints.LEN_REF_END]},
            { 'name' : SceneUtils.KnownLines.HORIZONTAL_REF_LINE, 'points' : [SceneUtils.KnownPoints.HORIZ_REF_START, SceneUtils.KnownPoints.HORIZ_REF_END]},
            ];

            self.angles['stepOneCanvas'] = [
            { 'name': SceneUtils.KnownAngles.ARM_FOREARM, 'side_first' : SceneUtils.KnownLines.ARM_LINE, 'side_second' : SceneUtils.KnownLines.FOREARM_LINE, 'ranges' : self.getRange('road', SceneUtils.KnownAngles.ARM_FOREARM), 'onAngleChanged' : onAngleChanged},
            
            { 'name': SceneUtils.KnownAngles.KNEE_EXTENSION, 'side_first' : SceneUtils.KnownLines.THIGH_LINE, 'side_second' : SceneUtils.KnownLines.SHIN_LINE, 'ranges' : self.getRange('road', SceneUtils.KnownAngles.KNEE_EXTENSION), 'onAngleChanged' : onAngleChanged},

            { 'name': SceneUtils.KnownAngles.HIP_OPEN, 'side_first' : SceneUtils.KnownLines.THIGH_LINE, 'side_second' : SceneUtils.KnownLines.BACK_LINE, 'onAngleChanged' : onAngleChanged},
            
            { 'name': SceneUtils.KnownAngles.ARM_PIT, 'side_first' : SceneUtils.KnownLines.BACK_LINE, 'side_second' : SceneUtils.KnownLines.ARM_LINE, 'ranges' : self.getRange('road', SceneUtils.KnownAngles.ARM_PIT), 'onAngleChanged' : onAngleChanged},
            
            { 'name': SceneUtils.KnownAngles.BACK_ANGLE, 'side_first' : SceneUtils.KnownLines.BACK_LINE, 'side_second' : SceneUtils.KnownLines.HORIZONTAL_REF_LINE, 'ranges' : self.getRange('road', SceneUtils.KnownAngles.BACK_ANGLE), 'onAngleChanged' : onAngleChanged},
            ];

            self.texts['stepOneCanvas'] = [
            { 'name' : 'HORIZONTAL_REF_LINE', text : 'Length reference', 'x' : 22, 'y' : 40},
            { 'name' : 'HORIZONTAL_REF_LINE', text : 'Horizontal reference', 'x' : 22, 'y' : 100},              
            ]

            var scene = new Scene(canvasId, $('.stepCanvasArea').width(), $('.stepCanvasArea').height());
            scene.load(self.points[canvasId], self.lines[canvasId], self.angles[canvasId], self.texts[canvasId]);

            view.onFrame = function (event) {
                scene.animateJoints(event);
            }

            return scene;
        }

        self.sceneTop = self.setupCanvas('stepOneCanvas');              

        [self.sceneTop].forEach(function (scene) {          
            // Arm line
            scene.onLineLengthChanged(function (f, t) { 
                self.updateLineSizes();
            }, SceneUtils.KnownLines.ARM_LINE);

            // Forearm line
            scene.onLineLengthChanged(function (f, t) { 
                self.updateLineSizes();
            }, SceneUtils.KnownLines.FOREARM_LINE);

            // Thigh line
            scene.onLineLengthChanged(function (f, t) { 
                self.updateLineSizes();
            }, SceneUtils.KnownLines.THIGH_LINE);

            // Shin line
            scene.onLineLengthChanged(function (f, t) {         
                self.updateLineSizes();
            }, SceneUtils.KnownLines.SHIN_LINE);

            // Hip to wrist
            scene.onLineLengthChanged(function (f, t) {
                self.updateLineSizes();
            }, SceneUtils.KnownLines.HIP_TO_WRIST);
            
            // Ref length line
            scene.onLineLengthChanged(function (from, to) {
                self.refDistanceInPixels = from.getDistance(to);
                self.updateLineSizes();     
            }, SceneUtils.KnownLines.DISTANCE_REF_LINE);

            // Custom tool
            scene.onLineLengthChanged(function (f, t) {
                self.updateLineSizes();
                updateCustomAngle();
            }, SceneUtils.KnownLines.CUSTOM_LINE);

            // Back line
            scene.onLineLengthChanged(function (f, t) {
                self.updateBackAngle();
            }, SceneUtils.KnownLines.BACK_LINE);    

            scene.onLineLengthChanged(function (f, t) {
                self.updateBackAngle();
            }, SceneUtils.KnownLines.HORIZONTAL_REF_LINE);  
        }); 

$($('.stepCanvasArea')[1]).hide();  
inputLength.val(50);
inputLength.trigger('change');
});
</script>

</body>
</html>
